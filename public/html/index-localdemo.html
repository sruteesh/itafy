<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">

  <title>Itafy</title>
  <meta name="description" content="Itafy">
    <meta name="Manuel Artero & Raúl Marcosl" content="Itafy">

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.6.0/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" type='text/css' href="../css/bootstrap.min.css" />
    <link rel='stylesheet' type='text/css' href='../css/menu.css' />
    <link rel='stylesheet' type='text/css' href='../css/realtime.css'></link>

    <script src='http://code.jquery.com/jquery-2.0.3.min.js' type="text/javascript"></script>
    <script src='http://api.tiles.mapbox.com/mapbox.js/v1.6.0/mapbox.js' type="text/javascript"></script>
    <script src="http://code.highcharts.com/highcharts.js" type="text/javascript"></script>
</head>
<body>
    <div id='cssmenu'>
        <ul>
           <li class='active'><a href='index-localdemo.html'><span>Tiempo Real</span></a></li>
           <li><a href='layout-test.html'><span>Dashboard</span></a></li>
           <li><a href='#'><span>Documentación</span></a></li>
           <li class='last'><a href='#'><span>About</span></a></li>
        </ul>
    </div>
    <div id='tweets-count'><h1><span id="tweets-number"></span> Tweets</h1></div>
    <div id="gender-charts"></div>
    <div id='map'></div>

    <script type="text/javascript">
        $(document).ready(function () {
            window.supermap = L.mapbox.map('map', 'raulmarcosl.h2di3h3g');
            window.supermap.addControl(L.mapbox.geocoderControl('map', 'raulmarcosl.h2di3h3g'));

            var webSocket = new WebSocket("ws://localhost:9000/onlive");
            var male = 0, female = 0, unknown = 0;
            var genderData = [];
            genderData[0] = 0;
            genderData[1] = 0;
            genderData[2] = 0;

            webSocket.onmessage = function (event) {

                var tweet = JSON.parse(event.data);
                // $("#tweets-feed").append('<p>' + tweet.gender + '</p>');
                $("#tweets-number").text(male + female + unknown);
                if (tweet.gender === 'male') {
                    male++;
                    genderData[1] = male;
                    marketColor = '#ACD1E9';
                } else if (tweet.gender === 'female') {
                    female++;
                    genderData[0] = female;
                    marketColor = '#FFBAD2';
                } else {
                    unknown++;
                    genderData[2] = unknown;
                    marketColor = '#333';
                }

                var marker = L.mapbox.marker.style({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [-77, 37.9]
                    },
                    properties: {
                        'marker-color': marketColor,
                        'marker-symbol': "post",
                    }
                }, [tweet.latitude, tweet.longitude]);


                var tweetUserDiv =
                    '<div class="tweet-user">' +
                        '<img src="' + tweet.profile_url + '" />' +
                        '<h3>@' + tweet.screen_name + '</h3>' +
                        '<h3>' + tweet.real_name + '</h3>' +
                    '</div>';

                var tweetTextDiv =
                    '<div class="tweet-text">' +
                            '<p>' + tweet.text + '</p>' +
                        '</div>';

                var tweetPhotoDiv = '';
                if (tweet.photo_url != null) {
                    var tweetPhotoDiv =
                    '<div class="tweet-photo">' +
                        '<img src="' + tweet.photo_url + '" />' +
                    '</div>';
                }

                var popupContent =
                    '<div class="popup">' +
                        tweetUserDiv +
                        tweetTextDiv +
                        tweetPhotoDiv +
                    '</div>';

                marker.bindPopup(popupContent, {
                    closeButton: true,
                    minWidth: 300
                });

                marker.addTo(window.supermap);
            };

        $('#gender-charts').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Gender'
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                categories: [
                    'Female',
                    'Male',
                    'Unknown'
                ]
            },
            yAxis: {
                min: 0,
                title: {
                    text: ''
                }
            },
            tooltip: {
                // headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                headerFormat: '',

                pointFormat: '<tr><td style="color:{series.color};padding:0"><td style="padding:0">{point.y} tweets</td></tr>',
                // pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                //     '<td style="padding:0"><b>{point.y} tweets</b></td></tr>',
                footerFormat: '',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                    // color: 'red'
                }
            },
            series: [{
                name: ' ',
                data: [
                    {
                        y: genderData[0], color: '#F6CECE'
                    },
                    {
                        y: genderData[1], color: '#A9D0F5'
                    },
                    {
                        y: genderData[2], color: '#333333'
                    }
                ]

            }]
        });

        interval = setInterval(function() {
            var chart = $("#gender-charts").highcharts();
            var data = [
                {
                    y: genderData[0], color: '#F6CECE'
                },
                {
                    y: genderData[1], color: '#A9D0F5'
                },
                {
                    y: genderData[2], color: '#333333'
                }
            ];

            if (chart != null) {
                chart.series[0].setData(genderData);
            }
        }, 500);
    });


    </script>
</body>
</html>

