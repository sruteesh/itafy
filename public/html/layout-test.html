b<html>
<head>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <script src='http://code.jquery.com/jquery-2.0.3.min.js' type="text/javascript"></script>
    <link rel='stylesheet' type='text/css' href='../css/menu.css' />
    <style type="text/css">
        body {
            margin:0;
            padding:0;
        }

            #map {
            position:relative;
        }

        #tweets-feed {
            overflow: auto;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id='cssmenu'>
        <ul>
           <li><a href='index-localdemo.html'><span>Tiempo Real</span></a></li>
           <li class='active'><a href='layout-test.html'><span>Dashboard</span></a></li>
           <li><a href='#'><span>Documentaci√≥n</span></a></li>
           <li class='last'><a href='#'><span>About</span></a></li>
        </ul>
    </div>

    <div style="height: 100%" id="map" class="col-md-6">
        B
    </div>

    <div class="col-md-3">
        <!-- GENDER -->
        <div id="gender-charts" class="row" style="height: 33%"></div>

        <!--  -->
        <div class="row" style="height: 33%">
            <div class="col-md-6">
                <span id="tweet-count">0</span> Tweets totales
            </div>
            <div class="col-md-6">
                <span id="tweet-average">0</span>Tweets / minuto
            </div>
        </div>
        <div class="row" style="height: 33%">
            A3
        </div>
    </div>

    <div id="tweets-feed" style="background-color: yellow" class="col-md-3" style="height: 100%">
        C
    </div>

    <script src='http://api.tiles.mapbox.com/mapbox.js/v1.6.0/mapbox.js' type="text/javascript"></script>
    <script src="http://code.highcharts.com/highcharts.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {

            var startDate = new Date();

            window.supermap = L.mapbox.map('map', 'raulmarcosl.h2di3h3g');
            window.supermap.addControl(L.mapbox.geocoderControl('map', 'raulmarcosl.h2di3h3g'));

            var webSocket = new WebSocket("ws://itafy.com/onlive");
            var male = 0, female = 0, unknown = 0;
            var genderData = [];
            webSocket.onmessage = function (event) {

                var tweet = JSON.parse(event.data);
                $("#tweets-feed").append('<p>' + tweet.gender + '</p>');

                if (tweet.gender === 'male') {
                    male++;
                    genderData[1] = male;
                    marketColor = '#ACD1E9';
                } else if (tweet.gender === 'female') {
                    female++;
                    genderData[0] = female;
                    marketColor = '#FFBAD2';
                } else {
                    unknown++;
                    genderData[2] = unknown;
                    marketColor = '#333';
                }

                var marker = L.mapbox.marker.style({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [-77, 37.9]
                    },
                    properties: {
                        'marker-color': marketColor,
                        'marker-symbol': "post",
                    }
                }, [tweet.latitude, tweet.longitude]);

                var popupContent =
                    '<div class="popup">' +
                        '<div class="tweet">' +
                            '<p>' + tweet.text + '</p>' +
                        '</div>' +
                    '</div>';

                marker.bindPopup(popupContent, {
                    closeButton: true,
                    minWidth: 100
                });

                marker.addTo(window.supermap);
            };

        $('#gender-charts').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Gender'
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                categories: [
                    'Female',
                    'Male'
                ]
            },
            yAxis: {
                min: 0,
                title: {
                    text: ''
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                    // color: 'red'
                }
            },
            series: [{
                name: 'Gender',
                // data: genderData
                data: [
                    {
                        y: genderData[0], color: '#F6CECE'
                    },
                    {
                        y: genderData[1], color: '#A9D0F5'
                    }
                ]

            }]
        });

        chartsInterval = setInterval(function() {
            var chart = $("#gender-charts").highcharts();
            var charData = [
                    {
                        y: genderData[0], color: '#F6CECE'
                    },
                    {
                        y: genderData[1], color: '#A9D0F5'
                    }
                ];
            chart.series[0].setData(charData);

            $('#tweet-count').text(male + female + unknown);

            var now = new Date();
            var diffMs = (now - startDate); // milliseconds between now & date of start
            var hours = Math.round((diffMs % 86400000) / 3600000); // hours
            var minutes = Math.round(((diffMs % 86400000) % 3600000) / 60000); // minutes
            var seconds = Math.round();

            $('#tweet-average').text((male + female + unknown) / minutes);
        }, 500);
    });

    </script>
</body>
</html>
